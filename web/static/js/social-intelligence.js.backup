/**
 * Social Intelligence Module
 * Handles Twitter/X, Reddit, News feeds and sentiment analysis
 */

class SocialIntelligence {
    constructor() {
        this.apiBase = '/api';
        this.data = {
            twitter: [],
            reddit: [],
            news: [],
            sentiment: null,
            trending: []
        };
        this.updateInterval = 60000; // 60 seconds
        this.intervalId = null;

        // Load settings from localStorage or use defaults
        this.settings = this.loadSettings();
    }

    /**
     * Load settings from localStorage
     */
    loadSettings() {
        const savedSettings = localStorage.getItem('odin-social-settings');
        if (savedSettings) {
            return JSON.parse(savedSettings);
        }

        // Default settings
        return {
            newsSources: ['coindesk', 'decrypt', 'cointelegraph'],
            subreddits: ['cryptocurrency', 'bitcoin', 'ethtrader'],
            twitterKeywords: ['bitcoin', 'crypto', 'btc', 'ethereum'],
            autoRefresh: true,
            refreshInterval: 60 // seconds
        };
    }

    /**
     * Save settings to localStorage
     */
    saveSettings() {
        localStorage.setItem('odin-social-settings', JSON.stringify(this.settings));
        console.log('üíæ Settings saved:', this.settings);
    }

    /**
     * Initialize social intelligence module
     */
    async init() {
        console.log('üåê Initializing Social Intelligence...');

        // Render UI structure
        this.renderUI();

        // Load all data
        await this.loadAllData();

        // Start auto-update
        this.startAutoUpdate();

        console.log('‚úÖ Social Intelligence initialized');
    }

    /**
     * Render the Social Intelligence UI
     */
    renderUI() {
        const container = document.getElementById('section-social');
        if (!container) return;

        const content = container.querySelector('.section-content');
        if (!content) return;

        content.innerHTML = `
            <!-- Settings Modal -->
            <div id="social-settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-panel); border: 1px solid var(--border-primary); border-radius: 8px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; font-size: 1.25rem;">‚öôÔ∏è Social Feed Settings</h2>
                        <button onclick="window.socialIntelligence.closeSettings()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>

                    <!-- News Sources -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">üì∞ News Sources</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="source-coindesk" onchange="window.socialIntelligence.updateNewsSources()">
                                <span>CoinDesk</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="source-decrypt" onchange="window.socialIntelligence.updateNewsSources()">
                                <span>Decrypt</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="source-cointelegraph" onchange="window.socialIntelligence.updateNewsSources()">
                                <span>CoinTelegraph</span>
                            </label>
                        </div>
                    </div>

                    <!-- Subreddits -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">üì± Subreddits</label>
                        <input type="text" id="subreddits-input" placeholder="cryptocurrency, bitcoin, ethtrader" style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 4px;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Comma-separated list of subreddit names</div>
                    </div>

                    <!-- Twitter Keywords -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">üê¶ Twitter Keywords</label>
                        <input type="text" id="twitter-keywords-input" placeholder="bitcoin, crypto, btc, ethereum" style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 4px;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">Comma-separated keywords to track</div>
                    </div>

                    <!-- Auto Refresh -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                            <input type="checkbox" id="auto-refresh-toggle" onchange="window.socialIntelligence.updateAutoRefresh()">
                            <span>üîÑ Auto-refresh feeds</span>
                        </label>
                        <div id="refresh-interval-container" style="margin-top: 0.5rem; margin-left: 1.5rem;">
                            <label style="display: block; font-size: 0.875rem; margin-bottom: 0.25rem;">Refresh interval (seconds)</label>
                            <input type="number" id="refresh-interval-input" min="30" max="300" step="10" style="width: 100px; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                        <button onclick="window.socialIntelligence.resetSettings()" style="padding: 0.75rem 1.5rem; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px; cursor: pointer;">
                            Reset to Defaults
                        </button>
                        <button onclick="window.socialIntelligence.applySettings()" style="padding: 0.75rem 1.5rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            Apply & Reload
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sentiment Overview -->
            <div class="terminal-panel" style="margin-bottom: var(--spacing-lg);">
                <div class="terminal-panel-header">
                    <span class="terminal-panel-title">Sentiment Overview</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="panel-toggle" onclick="window.socialIntelligence.openSettings()" title="Settings">‚öôÔ∏è</button>
                        <button class="panel-toggle" onclick="window.socialIntelligence.loadAllData()" title="Refresh">üîÑ</button>
                    </div>
                </div>
                <div class="terminal-panel-body">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-lg);">
                        <!-- Overall Sentiment Gauge -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase;">Overall Sentiment</div>
                            <div id="sentiment-gauge" style="font-size: 4rem; margin: 1rem 0;">üü°</div>
                            <div id="sentiment-score" style="font-size: 2rem; font-weight: 700; font-family: var(--font-mono);">50%</div>
                            <div id="sentiment-label" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Neutral</div>
                        </div>

                        <!-- By Platform -->
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase;">By Platform</div>
                            <div style="display: grid; gap: var(--spacing-sm);">
                                <div class="quick-stat" style="margin: 0;">
                                    <div class="quick-stat-label">Twitter/X</div>
                                    <div class="quick-stat-value" id="twitter-sentiment">--</div>
                                </div>
                                <div class="quick-stat" style="margin: 0;">
                                    <div class="quick-stat-label">Reddit</div>
                                    <div class="quick-stat-value" id="reddit-sentiment">--</div>
                                </div>
                                <div class="quick-stat" style="margin: 0;">
                                    <div class="quick-stat-label">News</div>
                                    <div class="quick-stat-value" id="news-sentiment">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trending Topics -->
            <div class="terminal-panel" style="margin-bottom: var(--spacing-lg);">
                <div class="terminal-panel-header">
                    <span class="terminal-panel-title">Trending Topics</span>
                </div>
                <div class="terminal-panel-body">
                    <div id="trending-topics" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-sm);">
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading trending topics...</div>
                    </div>
                </div>
            </div>

            <!-- Social Feeds Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--spacing-md);">
                <!-- Twitter Feed -->
                <div class="terminal-panel">
                    <div class="terminal-panel-header">
                        <span class="terminal-panel-title">üê¶ Twitter/X</span>
                    </div>
                    <div class="terminal-panel-body" style="max-height: 600px; overflow-y: auto;" id="twitter-feed">
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading tweets...</div>
                    </div>
                </div>

                <!-- Reddit Feed -->
                <div class="terminal-panel">
                    <div class="terminal-panel-header">
                        <span class="terminal-panel-title">üì± Reddit</span>
                    </div>
                    <div class="terminal-panel-body" style="max-height: 600px; overflow-y: auto;" id="reddit-feed">
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading posts...</div>
                    </div>
                </div>

                <!-- News Feed -->
                <div class="terminal-panel">
                    <div class="terminal-panel-header">
                        <span class="terminal-panel-title">üì∞ News</span>
                    </div>
                    <div class="terminal-panel-body" style="max-height: 600px; overflow-y: auto;" id="news-feed">
                        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading news...</div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Load all social data
     */
    async loadAllData() {
        console.log('üì• Loading social intelligence data...');

        try {
            // Load all feeds in parallel
            await Promise.all([
                this.loadSentiment(),
                this.loadTrending(),
                this.loadTwitterFeed(),
                this.loadRedditFeed(),
                this.loadNewsFeed()
            ]);
        } catch (error) {
            console.error('‚ùå Error loading social data:', error);
        }
    }

    /**
     * Load sentiment overview
     */
    async loadSentiment() {
        try {
            const response = await fetch(`${this.apiBase}/social/sentiment`);
            const result = await response.json();

            if (result.success) {
                this.data.sentiment = result.data;
                this.renderSentiment(result.data);
            }
        } catch (error) {
            console.error('Error loading sentiment:', error);
        }
    }

    /**
     * Render sentiment data
     */
    renderSentiment(data) {
        // Update gauge
        const gaugeEl = document.getElementById('sentiment-gauge');
        const scoreEl = document.getElementById('sentiment-score');
        const labelEl = document.getElementById('sentiment-label');

        if (gaugeEl) gaugeEl.textContent = data.overall_emoji || 'üü°';
        if (scoreEl) scoreEl.textContent = `${data.overall_score}%`;
        if (labelEl) labelEl.textContent = data.overall_label || 'Neutral';

        // Update platform scores
        const twitterEl = document.getElementById('twitter-sentiment');
        const redditEl = document.getElementById('reddit-sentiment');
        const newsEl = document.getElementById('news-sentiment');

        if (twitterEl && data.by_platform) {
            twitterEl.textContent = `${data.by_platform.twitter || 50}%`;
            twitterEl.style.color = this.getSentimentColor(data.by_platform.twitter || 50);
        }

        if (redditEl && data.by_platform) {
            redditEl.textContent = `${data.by_platform.reddit || 50}%`;
            redditEl.style.color = this.getSentimentColor(data.by_platform.reddit || 50);
        }

        if (newsEl && data.by_platform) {
            newsEl.textContent = `${data.by_platform.news || 50}%`;
            newsEl.style.color = this.getSentimentColor(data.by_platform.news || 50);
        }
    }

    /**
     * Get color based on sentiment score
     */
    getSentimentColor(score) {
        if (score >= 65) return 'var(--accent-success)';
        if (score <= 35) return 'var(--accent-danger)';
        return 'var(--text-secondary)';
    }

    /**
     * Load trending topics
     */
    async loadTrending() {
        try {
            const response = await fetch(`${this.apiBase}/social/trending`);
            const result = await response.json();

            if (result.success) {
                this.data.trending = result.data;
                this.renderTrending(result.data);
            }
        } catch (error) {
            console.error('Error loading trending:', error);
        }
    }

    /**
     * Render trending topics
     */
    renderTrending(topics) {
        const container = document.getElementById('trending-topics');
        if (!container) return;

        if (!topics || topics.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No trending topics found</div>';
            return;
        }

        container.innerHTML = topics.map(topic => `
            <div style="padding: 0.75rem; background: var(--bg-panel); border: 1px solid var(--border-primary); border-radius: 4px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-primary)'">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <span style="font-weight: 600; font-size: 0.875rem;">${topic.topic}</span>
                    <span style="font-size: 1.25rem;">${topic.emoji}</span>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); font-family: var(--font-mono);">${topic.mentions.toLocaleString()} mentions</div>
            </div>
        `).join('');
    }

    /**
     * Load Twitter feed
     */
    async loadTwitterFeed() {
        try {
            const response = await fetch(`${this.apiBase}/social/twitter`);
            const result = await response.json();

            if (result.success) {
                this.data.twitter = result.data;
                this.renderTwitterFeed(result.data);
            }
        } catch (error) {
            console.error('Error loading Twitter feed:', error);
        }
    }

    /**
     * Render Twitter feed
     */
    renderTwitterFeed(tweets) {
        const container = document.getElementById('twitter-feed');
        if (!container) return;

        if (!tweets || tweets.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No tweets found</div>';
            return;
        }

        container.innerHTML = tweets.map(tweet => `
            <div style="padding: 1rem; border-bottom: 1px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div>
                        <div style="font-weight: 600; font-size: 0.875rem;">@${tweet.author.username}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${this.formatTimeAgo(tweet.created_at)}</div>
                    </div>
                    ${this.renderSentimentBadge(tweet.sentiment)}
                </div>
                <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">${tweet.text}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); font-family: var(--font-mono);">
                    ‚ù§Ô∏è ${tweet.metrics.likes} üîÅ ${tweet.metrics.retweets} üí¨ ${tweet.metrics.replies}
                </div>
            </div>
        `).join('');
    }

    /**
     * Load Reddit feed
     */
    async loadRedditFeed() {
        try {
            const response = await fetch(`${this.apiBase}/social/reddit`);
            const result = await response.json();

            if (result.success) {
                this.data.reddit = result.data;
                this.renderRedditFeed(result.data);
            }
        } catch (error) {
            console.error('Error loading Reddit feed:', error);
        }
    }

    /**
     * Render Reddit feed
     */
    renderRedditFeed(posts) {
        const container = document.getElementById('reddit-feed');
        if (!container) return;

        if (!posts || posts.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No posts found</div>';
            return;
        }

        container.innerHTML = posts.map(post => `
            <div style="padding: 1rem; border-bottom: 1px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <a href="${post.url}" target="_blank" style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); text-decoration: none;" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-primary)'">${post.title}</a>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">r/${post.subreddit} ‚Ä¢ u/${post.author}</div>
                    </div>
                    ${this.renderSentimentBadge(post.sentiment)}
                </div>
                <div style="font-size: 0.75rem; color: var(--text-secondary); font-family: var(--font-mono);">
                    ‚¨Ü ${post.score} üí¨ ${post.num_comments}
                </div>
            </div>
        `).join('');
    }

    /**
     * Load news feed
     */
    async loadNewsFeed() {
        try {
            const response = await fetch(`${this.apiBase}/social/news`);
            const result = await response.json();

            if (result.success) {
                this.data.news = result.data;
                this.renderNewsFeed(result.data);
            }
        } catch (error) {
            console.error('Error loading news feed:', error);
        }
    }

    /**
     * Render news feed
     */
    renderNewsFeed(articles) {
        const container = document.getElementById('news-feed');
        if (!container) return;

        if (!articles || articles.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No articles found</div>';
            return;
        }

        container.innerHTML = articles.map(article => `
            <div style="padding: 1rem; border-bottom: 1px solid var(--border-subtle);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <a href="${article.url}" target="_blank" style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); text-decoration: none;" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-primary)'">${article.title}</a>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${article.source.toUpperCase()} ‚Ä¢ ${this.formatTimeAgo(article.published_at)}</div>
                    </div>
                    ${this.renderSentimentBadge(article.sentiment)}
                </div>
                <div style="font-size: 0.75rem; color: var(--text-tertiary);">${article.description}</div>
            </div>
        `).join('');
    }

    /**
     * Render sentiment badge
     */
    renderSentimentBadge(sentiment) {
        if (!sentiment) return '';

        const label = sentiment.label || 'neutral';
        let emoji = 'üòê';
        let badgeClass = 'info';

        if (label === 'positive') {
            emoji = 'üòä';
            badgeClass = 'success';
        } else if (label === 'negative') {
            emoji = 'üòû';
            badgeClass = 'danger';
        }

        return `<span class="terminal-badge ${badgeClass}" style="font-size: 0.75rem;">${emoji} ${label.toUpperCase()}</span>`;
    }

    /**
     * Format time ago
     */
    formatTimeAgo(timestamp) {
        const now = new Date();
        const then = new Date(timestamp);
        const seconds = Math.floor((now - then) / 1000);

        if (seconds < 60) return 'just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
    }

    /**
     * Start auto-update
     */
    startAutoUpdate() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
        }

        this.intervalId = setInterval(() => {
            this.loadAllData();
        }, this.updateInterval);

        console.log(`üîÑ Social Intelligence auto-update started (${this.updateInterval / 1000}s interval)`);
    }

    /**
     * Stop auto-update
     */
    stopAutoUpdate() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
            console.log('‚èπÔ∏è Social Intelligence auto-update stopped');
        }
    }

    /**
     * Destroy
     */
    destroy() {
        this.stopAutoUpdate();
    }
}

// Auto-initialize on window load
if (typeof window !== 'undefined') {
    window.SocialIntelligence = SocialIntelligence;
}
