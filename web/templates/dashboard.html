<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Trading Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #ffffff;
            opacity: 0.9;
        }

        .price-display {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .price-change {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .positive { color: #00ff88; }
        .negative { color: #ff4757; }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .metric-label {
            opacity: 0.8;
        }

        .metric-value {
            font-weight: 600;
        }

        .signal-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-buy {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }

        .signal-sell {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .signal-none {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .trend-bullish {
            color: #00ff88;
        }

        .trend-bearish {
            color: #ff4757;
        }

        .chart-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .error-message {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            color: #ff4757;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .price-display {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Bitcoin Trading Dashboard</h1>
            <div class="status">
                <div class="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <div id="error-container"></div>

        <div class="grid">
            <div class="card">
                <h3>üí∞ Current Price</h3>
                <div class="price-display" id="current-price">$0.00</div>
                <div class="price-change" id="price-change">0.00%</div>
            </div>

            <div class="card">
                <h3>üß† Strategy Status</h3>
                <div class="metric">
                    <span class="metric-label">Current Signal</span>
                    <span class="metric-value" id="current-signal">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Trend</span>
                    <span class="metric-value" id="current-trend">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">MA(5)</span>
                    <span class="metric-value" id="ma-short">$0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">MA(20)</span>
                    <span class="metric-value" id="ma-long">$0.00</span>
                </div>
            </div>

            <div class="card">
                <h3>‚è±Ô∏è System Info</h3>
                <div class="metric">
                    <span class="metric-label">Last Update</span>
                    <span class="metric-value" id="last-update">Never</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Data Points</span>
                    <span class="metric-value" id="data-points">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Strategy</span>
                    <span class="metric-value">MA(5,20)</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>üìà Price Chart with Moving Averages</h3>
            <div class="chart-wrapper">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart;
        let autoRefresh = true;
        let lastPrice = 0;
        let priceHistory = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            fetchData();
            startAutoRefresh();
        });

        // Initialize Chart.js with multiple datasets
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Bitcoin Price (USD)',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: '#00ff88',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }, {
                        label: 'MA(5)',
                        data: [],
                        borderColor: '#ffa500',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }, {
                        label: 'MA(20)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: 'white',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Fetch data from API
        async function fetchData() {
            try {
                updateStatus('Fetching data...', 'connecting');
                
                const priceResponse = await fetch('http://localhost:5000/api/current');
                let strategyData = null;
                
                try {
                    const strategyResponse = await fetch('http://localhost:5000/api/strategy/analysis');
                    if (strategyResponse.ok) {
                        strategyData = await strategyResponse.json();
                    }
                } catch (e) {
                    console.log('Strategy data not available');
                }
                
                if (!priceResponse.ok) {
                    throw new Error('API connection failed');
                }
                
                const priceData = await priceResponse.json();
                updateUI(priceData, strategyData);
                updateStatus('Live', 'connected');
                
            } catch (error) {
                console.error('Error:', error);
                showError('Connection failed - using demo data');
                updateStatus('Demo', 'error');
                
                // Demo data
                const mockData = {
                    price: 108500 + (Math.random() - 0.5) * 2000,
                    change24h: (Math.random() - 0.5) * 10,
                    high24h: 110000,
                    low24h: 107000,
                    volume24h: 45000000000,
                    dataPoints: 50
                };
                updateUI(mockData, null);
            }
        }

        // Update UI
        function updateUI(data, strategyData) {
            // Price
            document.getElementById('current-price').textContent = 
                '$' + data.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Price change
            const changeElement = document.getElementById('price-change');
            const changeText = (data.change24h >= 0 ? '+' : '') + data.change24h.toFixed(2) + '%';
            changeElement.textContent = changeText;
            changeElement.className = 'price-change ' + (data.change24h >= 0 ? 'positive' : 'negative');

            // Strategy data
            if (strategyData && !strategyData.error) {
                // Signal
                const signalElement = document.getElementById('current-signal');
                if (strategyData.current_signal) {
                    const signal = strategyData.current_signal.type;
                    signalElement.innerHTML = `<span class="signal-badge signal-${signal.toLowerCase()}">${signal}</span>`;
                } else {
                    signalElement.innerHTML = '<span class="signal-badge signal-none">WAITING</span>';
                }

                // Trend
                const trendElement = document.getElementById('current-trend');
                const trendClass = strategyData.trend === 'BULLISH' ? 'trend-bullish' : 'trend-bearish';
                trendElement.innerHTML = `<span class="${trendClass}">${strategyData.trend}</span>`;

                // MAs
                document.getElementById('ma-short').textContent = 
                    '$' + strategyData.ma_short.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('ma-long').textContent = 
                    '$' + strategyData.ma_long.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else {
                document.getElementById('current-signal').innerHTML = '<span class="signal-badge signal-none">N/A</span>';
                document.getElementById('current-trend').textContent = '-';
                document.getElementById('ma-short').textContent = '$0.00';
                document.getElementById('ma-long').textContent = '$0.00';
            }

            // System info
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            document.getElementById('data-points').textContent = data.dataPoints;

            // Update chart
            updateChart(data, strategyData);
        }

        // Update chart
        function updateChart(data, strategyData) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            priceHistory.push({
                time: timeLabel,
                price: data.price,
                ma_short: strategyData ? strategyData.ma_short : null,
                ma_long: strategyData ? strategyData.ma_long : null
            });

            // Keep last 50 points
            if (priceHistory.length > 50) {
                priceHistory = priceHistory.slice(-50);
            }

            // Update chart
            priceChart.data.labels = priceHistory.map(item => item.time);
            priceChart.data.datasets[0].data = priceHistory.map(item => item.price);
            priceChart.data.datasets[1].data = priceHistory.map(item => item.ma_short);
            priceChart.data.datasets[2].data = priceHistory.map(item => item.ma_long);
            
            priceChart.update('none');
        }

        // Utility functions
        function updateStatus(text, type) {
            document.getElementById('status-text').textContent = text;
            const dot = document.querySelector('.status-dot');
            
            switch(type) {
                case 'connected':
                    dot.style.background = '#00ff88';
                    break;
                case 'connecting':
                    dot.style.background = '#ffa500';
                    break;
                case 'error':
                    dot.style.background = '#ff4757';
                    break;
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function startAutoRefresh() {
            if (autoRefresh) {
                setTimeout(() => {
                    fetchData();
                    startAutoRefresh();
                }, 15000); // 15 second refresh
            }
        }
    </script>
</body>
</html>